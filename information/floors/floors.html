<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SBO:R Wiki – Floor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="/css/floor-hud.css" />

  <link rel="icon" href="/logo.png" type="image/png" />
  <link rel="apple-touch-icon" href="/logo.png" />
</head>

<body>

  <!-- ===== HUD TOP BAR ===== -->
  <header class="hud-top">
    <div class="hud-left">
      <div class="hud-kicker">SWORD BLOX ONLINE: REBIRTH</div>
      <div class="hud-title" id="floorTitle">FLOOR ?</div>
      <div class="hud-subtitle" id="floorSubtitle">LOADING…</div>
    </div>

    <nav class="hud-nav" aria-label="Floor navigation">
      <a class="hud-link" href="/index.html">HOME</a>
      <a class="hud-link" href="/information/">WIKI</a>
      <a class="hud-link active" href="/information/floors/">FLOORS</a>
    </nav>

    <div class="hud-right" id="floorTags"></div>
  </header>

  <!-- ===== MAIN GRID ===== -->
  <main class="floor-grid">

    <!-- LEFT COLUMN -->
    <aside class="col-left">

      <section class="hud-panel">
        <div class="panel-head"><span>FLOOR INFO</span></div>
        <ul class="hud-list bullets" id="floorInfo"></ul>
      </section>

      <section class="hud-panel">
        <div class="panel-head"><span>ACTIVITIES</span></div>
        <ul class="hud-list chevrons" id="floorActivities"></ul>
      </section>

      <section class="hud-panel">
        <div class="panel-head"><span>SHOPS</span></div>
        <ul class="hud-list chevrons" id="floorShops"></ul>
      </section>

    </aside>

    <!-- CENTER / MAP -->
    <section class="hud-panel panel-map">
      <div class="panel-head">
        <span>FLOOR LAYOUT PREVIEW</span>
        <span class="panel-chip" id="mapChip">FLOOR MAP</span>
      </div>

      <div class="map-frame">
        <div id="mapHost"></div>
      </div>

      <div class="hud-panel subpanel">
        <div class="panel-head slim"><span>KEY POINTS</span></div>
        <ul class="hud-list bullets" id="floorKeyPoints"></ul>
      </div>
    </section>

  </main>

  <div class="floor-note" id="systemNoteBox" hidden>
    <div class="floor-note-title">SYSTEM NOTE</div>
    <div class="floor-note-body" id="systemNote"></div>
  </div>

  <script>
    const byId = (id) => document.getElementById(id);

    function getFloorIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id") || "1";
    }

    function li(text) {
      const el = document.createElement("li");
      el.textContent = text;
      return el;
    }

    function chip(text, soft = false) {
      const el = document.createElement("div");
      el.className = soft ? "hud-chip hud-chip-soft" : "hud-chip";
      el.textContent = text;
      return el;
    }

    function renderList(targetUl, items) {
      targetUl.innerHTML = "";
      (items || []).forEach(item => targetUl.appendChild(li(item)));
    }

    function renderMap(map) {
      const host = byId("mapHost");
      host.innerHTML = "";

      // If an image is provided, show it. If it 404s, fallback to placeholder.
      const hasImage = map && map.image;

      if (hasImage) {
        const wrap = document.createElement("div");
        wrap.className = "map-image-wrap";

        const img = document.createElement("img");
        img.className = "map-img";
        img.src = map.image;
        img.alt = map.alt || "Floor map";

        // Callouts container overlays the image
        const overlay = document.createElement("div");
        overlay.className = "map-overlay";

        (map.callouts || []).forEach(c => {
          const co = document.createElement("div");
          co.className = "callout";
          co.textContent = c.label || "";

          // Support top/left/right/bottom from JSON
          if (c.top) co.style.top = c.top;
          if (c.left) co.style.left = c.left;
          if (c.right) co.style.right = c.right;
          if (c.bottom) co.style.bottom = c.bottom;

          overlay.appendChild(co);
        });

        // Fallback if image fails to load
        img.addEventListener("error", () => {
          host.innerHTML = "";
          host.appendChild(makePlaceholder(map));
        });

        wrap.appendChild(img);
        wrap.appendChild(overlay);
        host.appendChild(wrap);
        return;
      }

      host.appendChild(makePlaceholder(map));
    }

    function makePlaceholder(map) {
      const placeholder = document.createElement("div");
      placeholder.className = "map-placeholder";

      const scan = document.createElement("div");
      scan.className = "scanline";
      placeholder.appendChild(scan);

      (map?.callouts || []).forEach(c => {
        const co = document.createElement("div");
        co.className = "callout";
        co.textContent = c.label || "";

        if (c.top) co.style.top = c.top;
        if (c.left) co.style.left = c.left;
        if (c.right) co.style.right = c.right;
        if (c.bottom) co.style.bottom = c.bottom;

        placeholder.appendChild(co);
      });

      return placeholder;
    }

    async function init() {
      const floorId = getFloorIdFromURL();

      const res = await fetch("/data/floors.json", { cache: "no-store" });
      if (!res.ok) {
        byId("floorSubtitle").textContent = "FAILED TO LOAD FLOORS.JSON";
        return;
      }

      const data = await res.json();
      const floor = (data.floors || []).find(f => String(f.id) === String(floorId));

      if (!floor) {
        byId("floorTitle").textContent = "FLOOR NOT FOUND";
        byId("floorSubtitle").textContent = `No entry for id=${floorId}`;
        return;
      }

      // Top HUD
      byId("floorTitle").textContent = `FLOOR ${floor.number ?? floor.id}`;
      byId("floorSubtitle").textContent = (floor.name || "UNKNOWN FLOOR").toUpperCase();

      const tagsHost = byId("floorTags");
      tagsHost.innerHTML = "";
      (floor.tags || []).forEach((t, i) => tagsHost.appendChild(chip(t, i > 0)));

      // Lists
      renderList(byId("floorInfo"), floor.info);
      renderList(byId("floorActivities"), floor.activities);
      renderList(byId("floorShops"), floor.shops);
      renderList(byId("floorKeyPoints"), floor.keyPoints);

      // Map
      byId("mapChip").textContent = floor.name ? floor.name.toUpperCase() : "FLOOR MAP";
      renderMap(floor.map);

      // System note
      const noteBox = byId("systemNoteBox");
      const note = (floor.systemNote || "").trim();
      if (note) {
        byId("systemNote").textContent = note;
        noteBox.hidden = false;
      } else {
        noteBox.hidden = true;
      }

      // Update page title
      document.title = `SBO:R Wiki – Floor ${floor.number ?? floor.id}`;
    }

    init();
  </script>

</body>
</html>
